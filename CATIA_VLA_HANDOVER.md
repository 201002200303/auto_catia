# CATIA VLA é¡¹ç›®äº¤æ¥æ–‡æ¡£

> **é¡¹ç›®åç§°**: CATIA VLA-Hybrid Agentï¼ˆè§†è§‰-è¯­è¨€-åŠ¨ä½œæ··åˆæ¶æ„ï¼‰  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-08  
> **ç‰ˆæœ¬**: v2.0 Hybrid  
> **çŠ¶æ€**: âœ… v1.0 MVP + v2.0 Hybrid å·²å®Œæˆ

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç›®æ ‡

å°†ä¸‰ä¸ªç‹¬ç«‹æ¨¡å—æ•´åˆæˆä¸€ä¸ªç»Ÿä¸€çš„ CATIA è‡ªåŠ¨åŒ–æ™ºèƒ½ä½“ï¼š
- **OxyGent æ¡†æ¶**: æä¾› Agentã€LLMã€FunctionHub åŸºç¡€è®¾æ–½
- **pycatia**: CATIA COM API çš„ Python å°è£…ï¼Œç”¨äºå‚æ•°åŒ–å»ºæ¨¡
- **YOLO + è§†è§‰**: UI å…ƒç´ è¯†åˆ«å’Œé¼ æ ‡æ¨¡æ‹Ÿï¼Œç”¨äº GUI æ“ä½œ

### 1.2 æ ¸å¿ƒèƒ½åŠ›

```
ç”¨æˆ·: "åˆ›å»ºä¸€ä¸ª 100mm çš„ç«‹æ–¹ä½“"
    â†“
æ™ºèƒ½ä½“è‡ªåŠ¨æ‰§è¡Œ:
    1. create_new_part() â†’ åˆ›å»º CATIA æ–‡æ¡£
    2. create_rectangle_sketch() â†’ ç”»åº•é¢è‰å›¾
    3. create_pad() â†’ æ‹‰ä¼¸æˆç«‹æ–¹ä½“
    â†“
CATIA ä¸­å®é™…åˆ›å»ºäº†ç«‹æ–¹ä½“
```

---

## äºŒã€æ¶æ„æ€»è§ˆ

### 2.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚ (User Layer)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  run_chat.py (å¯¹è¯å…¥å£)                                      â”‚â”‚
â”‚  â”‚  - Web ç•Œé¢ / CLI å‘½ä»¤è¡Œ                                      â”‚â”‚
â”‚  â”‚  - è‡ªç„¶è¯­è¨€è¾“å…¥: "åˆ›å»ºä¸€ä¸ªç«‹æ–¹ä½“"                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ™ºèƒ½ä½“å±‚ (Agent Layer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ReActAgent      â”‚  â”‚ HostPlanner     â”‚  â”‚ Dispatcher      â”‚  â”‚
â”‚  â”‚ (æ¨ç†+è¡ŒåŠ¨)      â”‚  â”‚ (ä»»åŠ¡åˆ†è§£)       â”‚  â”‚ (æ¨¡æ€é€‰æ‹©)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å·¥å…·å±‚ (Tool Layer)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ catia_api_tools       â”‚      â”‚ catia_tools (è§†è§‰)         â”‚   â”‚
â”‚  â”‚ (FunctionHub)         â”‚      â”‚ (FunctionHub)              â”‚   â”‚
â”‚  â”‚ - create_new_part     â”‚      â”‚ - capture_screen           â”‚   â”‚
â”‚  â”‚ - create_rectangle    â”‚      â”‚ - detect_ui_elements       â”‚   â”‚
â”‚  â”‚ - create_pad          â”‚      â”‚ - click_element            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº•å±‚å°è£… (Base Layer)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ pycatia (COM API)     â”‚      â”‚ YOLO + pyautogui          â”‚   â”‚
â”‚  â”‚ - å‚æ•°åŒ–å»ºæ¨¡           â”‚      â”‚ - UI è¯†åˆ«                  â”‚   â”‚
â”‚  â”‚ - ç²¾ç¡®ã€é«˜é€Ÿ           â”‚      â”‚ - é¼ æ ‡æ¨¡æ‹Ÿ                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CATIA V5 è½¯ä»¶                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡æ€é€‰æ‹©ç­–ç•¥

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç”¨æˆ·è¯·æ±‚       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  åˆ†ææ“ä½œç±»å‹    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                             â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ å‡ ä½•å»ºæ¨¡æ“ä½œ?    â”‚           â”‚ GUI äº¤äº’æ“ä½œ?    â”‚
     â”‚ (è‰å›¾/æ‹‰ä¼¸/åœ†è§’) â”‚           â”‚ (ç‚¹å‡»/å¯¹è¯æ¡†)    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                             â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ æ¨¡æ€ A: API     â”‚           â”‚ æ¨¡æ€ B: è§†è§‰    â”‚
     â”‚ (pycatia)       â”‚           â”‚ (YOLO+ç‚¹å‡»)     â”‚
     â”‚ é«˜é€Ÿã€ç²¾å‡†      â”‚           â”‚ é«˜å…¼å®¹æ€§        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ–°å¢æ–‡ä»¶æ¸…å•

### 3.1 æ–‡ä»¶ç»“æ„æ ‘

```
OxyGent-main/
â”œâ”€â”€ CATIA_VLA_HANDOVER.md          # ğŸ‘ˆ æœ¬æ–‡æ¡£ï¼ˆäº¤æ¥æ–‡æ¡£ï¼‰
â”‚
â”œâ”€â”€ mcp_servers/
â”‚   â””â”€â”€ catia_mcp_server.py        # [v1.0] MCP Server å°è£…
â”‚
â”œâ”€â”€ function_hubs/
â”‚   â””â”€â”€ catia_api_tools.py         # [v1.0] API FunctionHub
â”‚
â”œâ”€â”€ applications/catia_vla/
â”‚   â”œâ”€â”€ README.md                  # [æ–‡æ¡£] é¡¹ç›®è“å›¾
â”‚   â”œâ”€â”€ DEV_PLAN.md                # [æ–‡æ¡£] å¼€å‘è®¡åˆ’
â”‚   â”œâ”€â”€ config.example.txt         # [é…ç½®] LLM é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ run_chat.py                # [å…¥å£] ç«¯åˆ°ç«¯å¯¹è¯å»ºæ¨¡ â­
â”‚   â”œâ”€â”€ main_api_agent.py          # [v1.0] API-only Agent
â”‚   â”œâ”€â”€ main_hybrid_agent.py       # [v2.0] æ··åˆ Agent
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”œâ”€â”€ dispatcher.py          # [v2.0] æ··åˆè°ƒåº¦å™¨
â”‚   â”‚   â””â”€â”€ host_planner.py        # [v2.0] ä»»åŠ¡è§„åˆ’å™¨
â”‚   â”‚
â”‚   â””â”€â”€ knowledge/
â”‚       â””â”€â”€ rag_retriever.py       # [v2.0] RAG çŸ¥è¯†æ£€ç´¢
â”‚
â””â”€â”€ test/integration/
    â”œâ”€â”€ test_catia_api_v1.py       # [v1.0] API æµ‹è¯•å¥—ä»¶
    â””â”€â”€ test_hybrid_v2.py          # [v2.0] æ··åˆæµ‹è¯•å¥—ä»¶
```

### 3.2 æ–‡ä»¶åŠŸèƒ½è¯¦è§£

#### ğŸ”µ åŸºç¡€å°è£…å±‚ï¼ˆç›´æ¥æ“ä½œ CATIAï¼‰

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®ç±»/å‡½æ•° |
|------|------|------------|
| `mcp_servers/catia_mcp_server.py` | MCP åè®®å°è£… pycatiaï¼Œå¯ç‹¬ç«‹è¿è¡Œ | `@mcp.tool` è£…é¥°å™¨å®šä¹‰å·¥å…· |
| `function_hubs/catia_api_tools.py` | OxyGent FunctionHub å°è£… pycatia | `catia_api_tools` FunctionHub å®ä¾‹ |

**å·¥å…·æ¸…å•**ï¼š
```python
# catia_api_tools æä¾›çš„ 7 ä¸ªå·¥å…·
create_new_part()           # åˆ›å»ºæ–° Part æ–‡æ¡£
create_rectangle_sketch()   # åˆ›å»ºçŸ©å½¢è‰å›¾
create_pad()                # åˆ›å»ºå‡¸å°ï¼ˆæ‹‰ä¼¸ï¼‰
create_extrude()            # åˆ›å»ºæ›²é¢æ‹‰ä¼¸
create_fillet()             # åˆ›å»ºåœ†è§’
get_part_info()             # è·å–æ¨¡å‹ä¿¡æ¯
save_part()                 # ä¿å­˜æ–‡ä»¶
```

#### ğŸŸ¢ æ™ºèƒ½ä½“å±‚ï¼ˆå†³ç­–å’Œè§„åˆ’ï¼‰

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®ç±»/å‡½æ•° |
|------|------|------------|
| `agent/dispatcher.py` | æ ¹æ®æ“ä½œç±»å‹é€‰æ‹© API/è§†è§‰æ¨¡æ€ | `UnifiedDispatcher` ç±» |
| `agent/host_planner.py` | å°†ä»»åŠ¡åˆ†è§£ä¸ºæ­¥éª¤åºåˆ— | `HostPlanner` ç±»ï¼Œé¢„å®šä¹‰æ¨¡æ¿ |
| `knowledge/rag_retriever.py` | ä» SOP æ–‡æ¡£æ£€ç´¢ç›¸å…³çŸ¥è¯† | `SOPRetriever` ç±» |

#### ğŸŸ¡ åº”ç”¨å…¥å£å±‚ï¼ˆç”¨æˆ·äº¤äº’ï¼‰

| æ–‡ä»¶ | åŠŸèƒ½ | ä½¿ç”¨æ–¹å¼ |
|------|------|---------|
| `run_chat.py` | **ä¸»å…¥å£**ï¼Œå¯¹è¯å»ºæ¨¡ | `python run_chat.py` |
| `main_api_agent.py` | çº¯ API æ¨¡å¼ Agent | `python main_api_agent.py` |
| `main_hybrid_agent.py` | æ··åˆæ¨¡å¼ Agent | `python main_hybrid_agent.py` |

---

## å››ã€æ¥å£è°ƒç”¨é¡ºåº

### 4.1 å¯åŠ¨æµç¨‹

```
1. ç”¨æˆ·è¿è¡Œ: python run_chat.py
                    â†“
2. load_env() åŠ è½½ .env é…ç½®
                    â†“
3. create_oxy_space() åˆ›å»ºé…ç½®
   â”œâ”€â”€ HttpLLM (å¤§æ¨¡å‹å®¢æˆ·ç«¯)
   â”œâ”€â”€ catia_api_tools (å·¥å…·é›†)
   â””â”€â”€ ReActAgent (æ™ºèƒ½ä½“)
                    â†“
4. MAS(oxy_space) åˆå§‹åŒ–å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ
                    â†“
5. mas.start_web_service() å¯åŠ¨ Web UI
                    â†“
6. ç”¨æˆ·åœ¨æµè§ˆå™¨è¾“å…¥è¯·æ±‚
```

### 4.2 å•æ¬¡è¯·æ±‚å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "åˆ›å»ºä¸€ä¸ª100mmç«‹æ–¹ä½“"
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. ReActAgent â”‚  æ¥æ”¶è¯·æ±‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. è°ƒç”¨ LLM   â”‚  åˆ†æç”¨æˆ·æ„å›¾
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. è§£æå“åº”   â”‚  parse_llm_response_with_tool_code()
    â”‚    è¯†åˆ«å·¥å…·è°ƒç”¨â”‚  æ”¯æŒ JSON å’Œ tool_code æ ¼å¼
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. æ‰§è¡Œå·¥å…·   â”‚  è°ƒç”¨ catia_api_tools.create_new_part()
    â”‚    (ç¬¬1æ­¥)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. è¿”å›ç»“æœ   â”‚  {"success": true, "part_name": "Part1"}
    â”‚    ç»§ç»­å¾ªç¯   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    é‡å¤ 2-5 ç›´åˆ°å®Œæˆæ‰€æœ‰æ­¥éª¤
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. è¿”å›æœ€ç»ˆ   â”‚  "ç«‹æ–¹ä½“å·²åˆ›å»º"
    â”‚    å›ç­”ç»™ç”¨æˆ· â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å·¥å…·è°ƒç”¨é“¾

åˆ›å»ºç«‹æ–¹ä½“çš„å®Œæ•´è°ƒç”¨é“¾ï¼š

```python
# æ­¥éª¤ 1: åˆ›å»ºæ–‡æ¡£
ReActAgent 
  â†’ LLM è¿”å›: {"tool_name": "create_new_part", "arguments": {"visible": true}}
  â†’ catia_api_tools.create_new_part(visible=True)
    â†’ pycatia.catia()
    â†’ CATIA COM API
    â†’ è¿”å›: {"success": true, "part_name": "Part1"}

# æ­¥éª¤ 2: åˆ›å»ºè‰å›¾
ReActAgent
  â†’ LLM è¿”å›: {"tool_name": "create_rectangle_sketch", "arguments": {...}}
  â†’ catia_api_tools.create_rectangle_sketch(support_plane="PlaneXY", length=100, width=100)
    â†’ RectangleBuilder(part, ...)
    â†’ CATIA COM API
    â†’ è¿”å›: {"success": true, "name": "Sketch.1"}

# æ­¥éª¤ 3: æ‹‰ä¼¸
ReActAgent
  â†’ LLM è¿”å›: {"tool_name": "create_pad", "arguments": {...}}
  â†’ catia_api_tools.create_pad(profile_name="Sketch.1", height=100)
    â†’ PadBuilder(part, ...)
    â†’ CATIA COM API
    â†’ è¿”å›: {"success": true, "name": "Pad.1"}
```

---

## äº”ã€æ ¸å¿ƒä»£ç è§£æ

### 5.1 å·¥å…·å®šä¹‰ï¼ˆcatia_api_tools.pyï¼‰

```python
from oxygent.oxy import FunctionHub
from pydantic import Field

# åˆ›å»º FunctionHub å®ä¾‹
catia_api_tools = FunctionHub(
    name="catia_api_tools", 
    desc="CATIA å‚æ•°åŒ–å»ºæ¨¡ API å·¥å…·é›†"
)

# ä½¿ç”¨è£…é¥°å™¨å®šä¹‰å·¥å…·
@catia_api_tools.tool(description="åˆ›å»ºæ–°çš„ CATIA Part æ–‡æ¡£")
def create_new_part(
    visible: bool = Field(True, description="æ˜¯å¦æ˜¾ç¤º CATIA çª—å£")
) -> str:
    """å·¥å…·å®ç°"""
    try:
        part = _get_catia_part(visible=visible)
        return json.dumps({
            "success": True, 
            "part_name": part.name,
            "message": "Part æ–‡æ¡£åˆ›å»ºæˆåŠŸ"
        })
    except Exception as e:
        return json.dumps({"success": False, "message": str(e)})
```

### 5.2 è‡ªå®šä¹‰ LLM å“åº”è§£æå™¨ï¼ˆrun_chat.pyï¼‰

```python
def parse_llm_response_with_tool_code(ori_response: str, oxy_request=None) -> LLMResponse:
    """
    æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
    1. JSON: ```json {"tool_name": "xxx", "arguments": {...}} ```
    2. tool_code: ```tool_code create_new_part() ```
    """
    
    # 1. å°è¯• JSON æ ¼å¼
    json_matches = re.findall(r"```[\n]*json(.*?)```", ori_response, re.DOTALL)
    if json_matches:
        tool_call_dict = json.loads(json_matches[0])
        if "tool_name" in tool_call_dict:
            return LLMResponse(state=LLMState.TOOL_CALL, output=tool_call_dict)
    
    # 2. å°è¯• tool_code æ ¼å¼
    tool_code_matches = re.findall(r"```tool_code\s*\n?(.*?)```", ori_response, re.DOTALL)
    if tool_code_matches:
        # è§£æ function_name(arg1=val1, ...)
        func_match = re.match(r"(\w+)\s*\((.*)\)", tool_code_matches[0])
        tool_name = func_match.group(1)
        arguments = parse_arguments(func_match.group(2))
        return LLMResponse(
            state=LLMState.TOOL_CALL, 
            output={"tool_name": tool_name, "arguments": arguments}
        )
    
    # 3. æ™®é€šå›ç­”
    return LLMResponse(state=LLMState.ANSWER, output=ori_response)
```

### 5.3 æ··åˆè°ƒåº¦å™¨ï¼ˆdispatcher.pyï¼‰

```python
class UnifiedDispatcher:
    """æ ¹æ®æ“ä½œç±»å‹è‡ªåŠ¨é€‰æ‹©æ‰§è¡Œæ¨¡æ€"""
    
    def __init__(self, api_tools, vision_tools, enable_fallback=True):
        self.api_tools = api_tools
        self.vision_tools = vision_tools
        self.enable_fallback = enable_fallback
    
    async def execute(self, operation: str, params: dict) -> ExecutionResult:
        # 1. åˆ¤æ–­æ¨¡æ€
        modality = self.get_modality(operation)
        
        if modality == ExecutionModality.API:
            # 2. å…ˆå°è¯• API
            result = await self._execute_api(operation, params)
            
            # 3. å¤±è´¥åˆ™é™çº§åˆ°è§†è§‰
            if not result.success and self.enable_fallback:
                result = await self._execute_vision(operation, params)
                result.fallback_used = True
        
        return result
```

---

## å…­ã€æ•°æ®æµæ¨¡æ‹Ÿï¼ˆDebug è§†è§’ï¼‰

### 6.1 åœºæ™¯ï¼šç”¨æˆ·è¾“å…¥"åˆ›å»ºä¸€ä¸ª100mmç«‹æ–¹ä½“"

```
[17:10:00] ğŸ“¥ ç”¨æˆ·è¾“å…¥: "åˆ›å»ºä¸€ä¸ª100mmç«‹æ–¹ä½“"

[17:10:00] ğŸ”„ run_chat.py: æ”¶åˆ°è¯·æ±‚
           â†’ MAS.chat_with_agent(payload={"query": "åˆ›å»ºä¸€ä¸ª100mmç«‹æ–¹ä½“"})

[17:10:00] ğŸ¤– ReActAgent: å¼€å§‹å¤„ç†
           â†’ è°ƒç”¨ LLM åˆ†æç”¨æˆ·æ„å›¾

[17:10:02] ğŸ“¡ HttpLLM: å‘é€è¯·æ±‚åˆ°å¤§æ¨¡å‹
           â†’ POST https://api.deepseek.com/v1/chat/completions
           â†’ messages: [ç³»ç»Ÿæç¤º + ç”¨æˆ·è¾“å…¥]

[17:10:05] ğŸ“© LLM è¿”å›:
           ```tool_code
           create_new_part()
           ```

[17:10:05] ğŸ” parse_llm_response_with_tool_code: è§£æå“åº”
           â†’ è¯†åˆ«ä¸º tool_code æ ¼å¼
           â†’ æå–: tool_name="create_new_part", arguments={}
           â†’ è¿”å› LLMResponse(state=TOOL_CALL)

[17:10:05] ğŸ”§ ReActAgent: æ‰§è¡Œå·¥å…·è°ƒç”¨
           â†’ catia_api_tools.create_new_part()

[17:10:05] ğŸ“¦ catia_api_tools.create_new_part:
           â†’ _get_catia_part(visible=True)
           â†’ pycatia.catia() è¿æ¥ CATIA

[17:10:06] ğŸ–¥ï¸ CATIA COM API:
           â†’ åˆ›å»ºæ–° Part æ–‡æ¡£
           â†’ è¿”å› Part å¯¹è±¡

[17:10:06] âœ… å·¥å…·è¿”å›:
           {"success": true, "part_name": "Part1", "message": "Part æ–‡æ¡£åˆ›å»ºæˆåŠŸ"}

[17:10:06] ğŸ”„ ReActAgent: ç»§ç»­å¾ªç¯ï¼Œå†æ¬¡è°ƒç”¨ LLM
           â†’ å‘Šè¯‰ LLM å·¥å…·æ‰§è¡Œç»“æœ

[17:10:08] ğŸ“© LLM è¿”å›:
           ```tool_code
           create_rectangle_sketch(support_plane="PlaneXY", length=100, width=100)
           ```

[17:10:08] ğŸ” è§£æå™¨:
           â†’ tool_name="create_rectangle_sketch"
           â†’ arguments={"support_plane": "PlaneXY", "length": 100, "width": 100}

[17:10:08] ğŸ”§ æ‰§è¡Œ:
           â†’ catia_api_tools.create_rectangle_sketch(...)
           â†’ RectangleBuilder(part, support_name="PlaneXY", length=100, width=100)

[17:10:09] ğŸ–¥ï¸ CATIA:
           â†’ åœ¨ XY å¹³é¢åˆ›å»º 100x100 çŸ©å½¢è‰å›¾
           â†’ è‰å›¾å‘½åä¸º "Sketch.1"

[17:10:09] âœ… è¿”å›:
           {"success": true, "name": "Sketch.1", "message": "çŸ©å½¢è‰å›¾åˆ›å»ºæˆåŠŸ"}

[17:10:09] ğŸ”„ ReActAgent: ç»§ç»­

[17:10:11] ğŸ“© LLM è¿”å›:
           ```tool_code
           create_pad(profile_name="Sketch.1", height=100)
           ```

[17:10:11] ğŸ”§ æ‰§è¡Œ:
           â†’ catia_api_tools.create_pad(profile_name="Sketch.1", height=100)
           â†’ PadBuilder(part, profile_name="Sketch.1", limit1=100)

[17:10:12] ğŸ–¥ï¸ CATIA:
           â†’ å°† Sketch.1 å‘ Z è½´æ‹‰ä¼¸ 100mm
           â†’ åˆ›å»ºå®ä½“å‡¸å° "Pad.1"

[17:10:12] âœ… è¿”å›:
           {"success": true, "name": "Pad.1", "message": "å‡¸å°åˆ›å»ºæˆåŠŸ"}

[17:10:12] ğŸ”„ ReActAgent: å†æ¬¡è°ƒç”¨ LLM

[17:10:14] ğŸ“© LLM è¿”å›æœ€ç»ˆç­”æ¡ˆï¼ˆæ— å·¥å…·è°ƒç”¨ï¼‰:
           "âœ… 100mm ç«‹æ–¹ä½“å·²æˆåŠŸåˆ›å»ºï¼"

[17:10:14] ğŸ” è§£æå™¨:
           â†’ æœªæ£€æµ‹åˆ°å·¥å…·è°ƒç”¨
           â†’ è¿”å› LLMResponse(state=ANSWER)

[17:10:14] âœ… ReActAgent: ä»»åŠ¡å®Œæˆ
           â†’ è¿”å›æœ€ç»ˆç­”æ¡ˆç»™ç”¨æˆ·

[17:10:14] ğŸ“¤ ç”¨æˆ·çœ‹åˆ°:
           "âœ… 100mm ç«‹æ–¹ä½“å·²æˆåŠŸåˆ›å»ºï¼"

[17:10:14] ğŸ–¥ï¸ CATIA çª—å£ä¸­:
           â†’ æ˜¾ç¤ºä¸€ä¸ª 100x100x100mm çš„ç«‹æ–¹ä½“
```

### 6.2 å¤±è´¥é™çº§æµç¨‹ï¼ˆDispatcher åœºæ™¯ï¼‰

```
[å‡è®¾åœºæ™¯] ç”¨æˆ·è¯·æ±‚ç‚¹å‡»"ä¿å­˜"æŒ‰é’®

[17:20:00] ğŸ“¥ è¯·æ±‚: operation="save_file"

[17:20:00] ğŸ”„ Dispatcher.execute:
           â†’ get_modality("save_file") = HYBRID (æ··åˆæ¨¡å¼)

[17:20:00] ğŸ”§ å°è¯• API:
           â†’ _execute_api("save_file", params)
           â†’ save_part() è°ƒç”¨å¤±è´¥ï¼ˆéœ€è¦é€‰æ‹©ä¿å­˜è·¯å¾„ï¼‰

[17:20:01] âš ï¸ API å¤±è´¥:
           {"success": false, "message": "éœ€è¦ç”¨æˆ·é€‰æ‹©ä¿å­˜è·¯å¾„"}

[17:20:01] ğŸ”„ å¯ç”¨é™çº§:
           â†’ enable_fallback=True
           â†’ åˆ‡æ¢åˆ°è§†è§‰æ¨¡å¼

[17:20:01] ğŸ‘ï¸ å°è¯•è§†è§‰:
           â†’ _execute_vision("save_file", params)
           â†’ capture_screen() â†’ detect_ui_elements() â†’ click_element()

[17:20:03] âœ… è§†è§‰æˆåŠŸ:
           {"success": true, "message": "å·²ç‚¹å‡»ä¿å­˜æŒ‰é’®", "fallback_used": true}

[17:20:03] ğŸ“Š ç»Ÿè®¡æ›´æ–°:
           â†’ api_calls: 1
           â†’ vision_calls: 1
           â†’ fallbacks: 1
```

---

## ä¸ƒã€å¿«é€Ÿå¼€å§‹

### 7.1 ç¯å¢ƒé…ç½®

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\catia_OxyGent\OxyGent-main\applications\catia_vla

# 2. å¤åˆ¶é…ç½®æ¨¡æ¿
copy config.example.txt .env

# 3. ç¼–è¾‘ .envï¼Œå¡«å†™ LLM é…ç½®
notepad .env
```

`.env` å†…å®¹ï¼š
```ini
DEFAULT_LLM_API_KEY="sk-your-api-key"
DEFAULT_LLM_BASE_URL="https://api.deepseek.com/v1"
DEFAULT_LLM_MODEL_NAME="deepseek-chat"
```

### 7.2 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ CATIAï¼ˆæ‰‹åŠ¨ï¼‰

# å¯åŠ¨å¯¹è¯æœåŠ¡
python run_chat.py
```

### 7.3 å¯¹è¯å»ºæ¨¡

åœ¨ Web ç•Œé¢è¾“å…¥ï¼š
```
åˆ›å»ºä¸€ä¸ª 150mm çš„ç«‹æ–¹ä½“
```

---

## å…«ã€æµ‹è¯•å‘½ä»¤

```bash
# v1.0 API æµ‹è¯•ï¼ˆä¸éœ€è¦ CATIAï¼‰
pytest test/integration/test_catia_api_v1.py -v -m "not catia_required"

# v1.0 å®Œæ•´æµ‹è¯•ï¼ˆéœ€è¦ CATIAï¼‰
pytest test/integration/test_catia_api_v1.py -v

# v2.0 æ··åˆæµ‹è¯•
pytest test/integration/test_hybrid_v2.py -v
```

---

## ä¹ã€æ‰©å±•æŒ‡å—

### 9.1 æ·»åŠ æ–°å·¥å…·

åœ¨ `function_hubs/catia_api_tools.py` ä¸­ï¼š

```python
@catia_api_tools.tool(description="åˆ›å»ºåœ†å½¢è‰å›¾")
def create_circle_sketch(
    support_plane: str = Field(..., description="æ”¯æŒå¹³é¢"),
    radius: float = Field(..., description="åŠå¾„(mm)")
) -> str:
    try:
        part = _get_catia_part()
        # å®ç°é€»è¾‘...
        return json.dumps({"success": True, ...})
    except Exception as e:
        return json.dumps({"success": False, "message": str(e)})
```

### 9.2 æ·»åŠ æ–°æ¨¡æ¿ï¼ˆHostPlannerï¼‰

åœ¨ `agent/host_planner.py` çš„ `TASK_TEMPLATES` ä¸­ï¼š

```python
TASK_TEMPLATES = {
    "create_cylinder": [
        TaskStep(id="step_1", tool_name="create_new_part", ...),
        TaskStep(id="step_2", tool_name="create_circle_sketch", ...),
        TaskStep(id="step_3", tool_name="create_pad", ...),
    ],
    # ...
}
```

---

## åã€å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| LLM åªæè¿°ä¸æ‰§è¡Œ | è‡ªå®šä¹‰ prompt è¦†ç›–äº†å·¥å…·è°ƒç”¨æ ¼å¼ | ä½¿ç”¨ `additional_prompt` è€Œé `prompt` |
| å·¥å…·è°ƒç”¨æœªè§¦å‘ | LLM è¾“å‡ºæ ¼å¼ä¸è¢«è¯†åˆ« | ä½¿ç”¨è‡ªå®šä¹‰è§£æå™¨ `parse_llm_response_with_tool_code` |
| CATIA è¿æ¥å¤±è´¥ | CATIA æœªå¯åŠ¨æˆ– COM æƒé™é—®é¢˜ | å…ˆå¯åŠ¨ CATIAï¼Œä»¥ç®¡ç†å‘˜è¿è¡Œ Python |
| ChromaDB SSL é”™è¯¯ | Windows ä¸Šçš„å…¼å®¹æ€§é—®é¢˜ | RAG è‡ªåŠ¨å›é€€åˆ°å†…å­˜æ¨¡å¼ |

---

## åä¸€ã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å†…å®¹ |
|------|------|------|
| v1.0 MVP | 2025-12-08 | API å·¥å…·å°è£…ã€åŸºç¡€ Agent |
| v2.0 Hybrid | 2025-12-23 | æ··åˆè°ƒåº¦ã€RAGã€ä»»åŠ¡è§„åˆ’ |
| v2.1 | 2026-01-08 | è‡ªå®šä¹‰è§£æå™¨æ”¯æŒ tool_code æ ¼å¼ |

---

**æ–‡æ¡£ç»“æŸ**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…æˆ–æŸ¥é˜… `applications/catia_vla/README.md`ã€‚

